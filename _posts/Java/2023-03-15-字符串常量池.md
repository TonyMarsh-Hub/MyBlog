---
layout: post
title: 动态创建、拼接的String是否会被自动放入字符串常量池中?若会，则会在什么时机被放入字符串常量池中
date: 2023-03-15 00:07 +0800
math: true
mermaid: true
category: [Java]
tag: [字符串常量池]
---
基本的八股文概念就不赘述了，本文主要讲解自己踩的坑
# 写在最前：不会

## 起因

思考标题中的这个问题时,使用了如下代码进行验证

```java
String abcd = new StringBuilder().append("ab").append("cd").toString();
System.out.println(abcd.intern() == abcd);
```

结果返回为True，我便以为动态创建的String会被自动存入字符串常量池中。  
但仔细想想又不对劲,动态创建的String最终又会被存储静态变量池，这样的设计意义何在？  
但是我又想到  其实我这种写法就是`String abcd = "ab" + "cd"`经过编译器优化后的结果,那么最终abcd会被存储字符串常量池中也确实符合逻辑。  
但是有一个反例出现了，我把代码中的字符串字面值换成变量，而返回结果仍然是ture，这又让我无法解释。

## 坑1：一个对`intern()`的错误用法

我显然是想要验证，一个字符串是否在字符串常量池中。  
但我实际做的事情是：查看`intern()`方法的返回值是否等于字符串本身。  
这两者真的等价吗？

### `intern()`是用来干什么的？  
`intern()`方法会返回字符串对象在常量池中对应的版本的引用。  
即如果常量池中已经包含一个等于此String对象内容的字符串，则返回常量池中该字符串的引用；
否则，将此String对象包含的字符串添加到常量池中，再返回此String对象的引用。

### 那我用`intern()`方法来验证字符串是否在字符串常量池中，有什么问题呢?  
问题就在于调用`intern()`方法后，字符串必定被加入到字符串常量池中。  
我们已经将字符串放入常量池了，此时再去验证字符串是否在常量池中，显然是没有意义的。

具体来说,对于一个从未在字符串常量池中出现过的字符串x  
`x.intern() == x`是一个值为ture的恒等式

## 坑2：一种对字符串常量池机制的错误想象

`intern()`的方法说明中，当参数没有在字符串常量池中出现过时，会将参数放入字符串常量池中。
我原本理解的是新创建一个字符串对象，然后将其放入字符串常量池中，但其实不是这样的。

### 什么叫做放入字符串常量池中
新建一个对象的确是jdk1.7之前的做法，但是在之后的版本中发生了变化。  
实际上，在高版本的jdk中，字符串常量池所在的位置发生了变化，它不再是永久代中的一部分，而是被移到了堆中。  
既然就是在堆中，那么又何必创建重复的对象，所以实际上放入的行为就是将String的引用存储到字符串常量池中。

### 字符串常量池的初始化时间
字符串常量池的初始化时间是在JVM启动(新版本是类加载的时候)，总之是一个非常早的时间点。  
对于代码中你所看到的一切字符串，只要它们是字面值(用`""`包裹)，都会被放入字符串常量池中。

## 回顾一些具有误导性的例子，以及正确的理解

### 一个简单的例子
```java
String a = "a";
System.out.println(a.intern() == a); // true

String _a = new String("a");
System.out.println( _a.intern() == _a); // false
```
正确的理解：首先不能用`intern()`来判断字符串是否在字符串常量池中，但我们先看下去。  
首先，`"a"`是一个字面值，所以它会一开始就被放入字符串常量池中。  
继续分析 `a`的值是"a"在常量池中的引用， `_a`的值是新创建在堆中的一个对象的引用。  
因为`"a"`已经在常量池中存在，所以a.intern() 返回`"a"`在常量池中的引用，`_a.intern()`返回的也是`"a"`在常量池中的引用。
这就解释了为什么第一个是true，第二个是false。

### 解释最开始的例子
```java
String abcd = new StringBuilder().append("ab").append("cd").toString();
System.out.println(abcd.intern() == abcd); // true
```
首先，`"ab"` 和`"cd"`一开始就在常量池中了，接着Builder返回值的`"abcd"`的String对象`abcd`  
而常量池中没有值为`"abcd"`的对象，所以当执行`abcd.intern()`时，会将`abcd`的引用放入字符串常量池中，然后返回
那么最终的结果就是自己和自己比，就是true

### 如果这样写呢？
```java
String abcd = "abcd";

String abcd2 = new StringBuilder().append("abc").append("d").toString();
System.out.println(abcd2.intern() == abcd2);

```
结果就是false，因为这里的`"abcd"`是字面值，所以它一开始就在常量池中了，  
而`abcd2`是一个新创建的对象，执行`abcd2.intern()` 时，返回的引用是`abcd`，所以结果为false

### 小结
判断字符串是否在常量池中，直接和字面值比较而不是用 `intern()`方法的返回值和自己比较  
动态创建的String(通过拼接或new关键字生成)不会被加入到字符串常量池中，    
除非显式的调用`intern()`方法，这时候才会将其加入到字符串常量池中。

